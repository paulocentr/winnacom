// extract and compute all probability tables from winna
// used to generate the tables in verifier.js

// extreme data extracted from source:
// zi = .98 (adjustment constant, before extreme)
// Ir = .98 (similar constant, after high)
// I = { 8: {m1, m2}, 9: {m1, m2}, ... 16: {m1, m2} }
// Y(m1, m2, numBuckets) = generates probability array for extreme

const zi = 0.98;

const I = {
    8:  { m1: 0.00707071, m2: 0.04949495 },
    9:  { m1: 0.00549944, m2: 0.03093427 },
    10: { m1: 0.00309492, m2: 0.02062814 },
    11: { m1: 0.00198,    m2: 0.01375253 },
    12: { m1: 0.001375,   m2: 0.00825253 },
    13: { m1: 0.000825,   m2: 0.00618687 },
    14: { m1: 0.00049495, m2: 0.00412626 },
    15: { m1: 0.00033,    m2: 0.00291161 },
    16: { m1: 0.00012374, m2: 0.00247475 }
};

function Y(m1, m2, numBuckets) {
    const n = zi / 0.99;
    const i = m1 * n;
    const a = m2 * n;
    const d = 1 - (i * 2 + a * 2);
    const l = numBuckets - 4;
    const fill = l > 0 ? d / l : 0;
    const v = Array.from({ length: numBuckets }, () => fill);
    v[0] = i;
    v[1] = a;
    v[numBuckets - 2] = a;
    v[numBuckets - 1] = i;
    return v;
}

console.log('=== EXTREME PROBABILITY TABLES ===\n');
for (const pins of [8, 9, 10, 11, 12, 13, 14, 15, 16]) {
    const numBuckets = pins + 1;
    const probs = Y(I[pins].m1, I[pins].m2, numBuckets);
    const sum = probs.reduce((a, b) => a + b, 0);
    console.log(`${pins} pins (${numBuckets} buckets), sum=${sum.toFixed(10)}:`);
    console.log(`  [${probs.map(p => p.toPrecision(10)).join(', ')}]`);
    console.log();
}

// now generate output to copy into verifier.js
console.log('\n=== COPY-PASTE FOR VERIFIER.JS ===\n');

// prob tables extracted (low/medium/high from source, extreme computed)
const LOW = {
    8: [0.0019762983, 0.03125, 0.109375, 0.21875, 0.2753674517, 0.21875, 0.109375, 0.03125, 0.00390625],
    9: [0.0000096794, 0.017578125, 0.0703125, 0.1640625, 0.2481024752, 0.24609375, 0.1640625, 0.0703125, 0.017578125, 0.0018878454],
    10: [0.0000096058, 0.009765625, 0.0439453125, 0.1171875, 0.205078125, 0.2472887575, 0.205078125, 0.1171875, 0.0439453125, 0.009765625, 0.0007485117],
    11: [0.0000097792, 0.0042108638, 0.0268554687, 0.0805664063, 0.1611328125, 0.2277032498, 0.2255859375, 0.1611328125, 0.0805664063, 0.0268554687, 0.0053710938, 0.000009701],
    12: [0.0000095805, 0.0007943749, 0.0161132813, 0.0537109375, 0.1208496094, 0.193359375, 0.2281902653, 0.193359375, 0.1208496094, 0.0537109375, 0.0161132813, 0.0029296875, 0.0000096856],
    13: [0.000009887, 0.0000096514, 0.0095214844, 0.0349121094, 0.0872802734, 0.1571044922, 0.2122209395, 0.2094726562, 0.1571044922, 0.0872802734, 0.0349121094, 0.0095214844, 0.00064026, 0.000009887],
    14: [0.0000096301, 0.0000098232, 0.0031181839, 0.0222167969, 0.0610961914, 0.1221923828, 0.1832885742, 0.2137007598, 0.1832885742, 0.1221923828, 0.0610961914, 0.0222167969, 0.0055541992, 0.0000098831, 0.0000096301],
    15: [0.0000098735, 0.0000098868, 0.0019530623, 0.013885498, 0.0416564941, 0.0916442871, 0.1527404785, 0.1985689644, 0.1963806152, 0.1527404785, 0.0916442871, 0.0416564941, 0.013885498, 0.0032043457, 0.000009863, 0.0000098735],
    16: [0.0000096168, 0.000009747, 0.0000095379, 0.0081408415, 0.0277709961, 0.0666503906, 0.1221923828, 0.1745605469, 0.2009074574, 0.1745605469, 0.1221923828, 0.0666503906, 0.0277709961, 0.0085449219, 0.0000097213, 0.0000099066, 0.0000096168]
};

const MEDIUM = {
    8: [0.0031870833, 0.03125, 0.109375, 0.21875, 0.2741566667, 0.21875, 0.109375, 0.03125, 0.00390625],
    9: [0.0013013963, 0.017578125, 0.0703125, 0.1640625, 0.2467454787, 0.24609375, 0.1640625, 0.0703125, 0.017578125, 0.001953125],
    10: [0.0005570486, 0.009765625, 0.0439453125, 0.1171875, 0.205078125, 0.2465132639, 0.205078125, 0.1171875, 0.0439453125, 0.009765625, 0.0009765625],
    11: [0.0000528183, 0.0053710938, 0.0268554687, 0.0805664063, 0.1611328125, 0.2260214005, 0.2255859375, 0.1611328125, 0.0805664063, 0.0268554687, 0.0053710938, 0.0004882813],
    12: [0.0000098832, 0.0029296875, 0.0161132813, 0.0537109375, 0.1208496094, 0.193359375, 0.2258884324, 0.193359375, 0.1208496094, 0.0537109375, 0.0161132813, 0.0029296875, 0.0001759032],
    13: [0.0000099176, 0.0015561401, 0.0095214844, 0.0349121094, 0.0872802734, 0.1571044922, 0.209727671, 0.2094726562, 0.1571044922, 0.0872802734, 0.0349121094, 0.0095214844, 0.0015869141, 0.0000099822],
    14: [0.0000097504, 0.0005829438, 0.0055541992, 0.0222167969, 0.0610961914, 0.1221923828, 0.1832885742, 0.2098466526, 0.1832885742, 0.1221923828, 0.0610961914, 0.0222167969, 0.0055541992, 0.0008544922, 0.000009872],
    15: [0.0000098344, 0.0000985555, 0.0032043457, 0.013885498, 0.0416564941, 0.0916442871, 0.1527404785, 0.1967811592, 0.1963806152, 0.1527404785, 0.0916442871, 0.0416564941, 0.013885498, 0.0032043457, 0.0004577637, 0.000009865],
    16: [0.0000099993, 0.0000299303, 0.0018310547, 0.0085449219, 0.0277709961, 0.0666503906, 0.1221923828, 0.1745605469, 0.1966054369, 0.1745605469, 0.1221923828, 0.0666503906, 0.0277709961, 0.0085449219, 0.0018310547, 0.0002441406, 0.0000099069]
};

const HIGH = {
    8: [0.003537361, 0.03125, 0.109375, 0.21875, 0.273806389, 0.21875, 0.109375, 0.03125, 0.00390625],
    9: [0.0017049006, 0.017578125, 0.0703125, 0.1640625, 0.2463419744, 0.24609375, 0.1640625, 0.0703125, 0.017578125, 0.001953125],
    10: [0.0008364042, 0.009765625, 0.0439453125, 0.1171875, 0.205078125, 0.2462339083, 0.205078125, 0.1171875, 0.0439453125, 0.009765625, 0.0009765625],
    11: [0.0003914485, 0.0053710938, 0.0268554687, 0.0805664063, 0.1611328125, 0.2256827703, 0.2255859375, 0.1611328125, 0.0805664063, 0.0268554687, 0.0053710938, 0.0004882813],
    12: [0.0001784097, 0.0029296875, 0.0161132813, 0.0537109375, 0.1208496094, 0.1934251059, 0.2255859375, 0.193359375, 0.1208496094, 0.0537109375, 0.0161132813, 0.0029296875, 0.0002441406],
    13: [0.0000802376, 0.0015869141, 0.0095214844, 0.0349121094, 0.0872802734, 0.1571463249, 0.2094726563, 0.2094726563, 0.1571044922, 0.0872802734, 0.0349121094, 0.0095214844, 0.0015869141, 0.0001220703],
    14: [0.0000377343, 0.0008544922, 0.0055541992, 0.0222167969, 0.0610961914, 0.1221923828, 0.1833118751, 0.2094726562, 0.1832885742, 0.1221923828, 0.0610961914, 0.0222167969, 0.0055541992, 0.0008544922, 0.0000610352],
    15: [0.0000139576, 0.0004577637, 0.0032043457, 0.013885498, 0.0416564941, 0.0916442871, 0.1527570385, 0.1963806152, 0.1963806152, 0.1527404785, 0.0916442871, 0.0416564941, 0.013885498, 0.0032043457, 0.0004577637, 0.0000305176],
    16: [0.0000099831, 0.0002441406, 0.0018310547, 0.0085449219, 0.0277709961, 0.0666503906, 0.1222021482, 0.1745605469, 0.1963806152, 0.1745605469, 0.1221923828, 0.0666503906, 0.0277709961, 0.0085449219, 0.0018310547, 0.0002441406, 0.0000107691]
};

// compute extreme
const EXTREME = {};
for (const pins of [8, 9, 10, 11, 12, 13, 14, 15, 16]) {
    EXTREME[pins] = Y(I[pins].m1, I[pins].m2, pins + 1);
}

// verify sums
for (const [name, table] of [['low', LOW], ['medium', MEDIUM], ['high', HIGH], ['extreme', EXTREME]]) {
    for (const [pins, probs] of Object.entries(table)) {
        const sum = probs.reduce((a, b) => a + b, 0);
        if (Math.abs(sum - 1.0) > 0.001) {
            console.log(`WARNING: ${name}/${pins} sum=${sum}`);
        }
    }
}
console.log('all sums verified ~1.0\n');

// output in format for verifier.js
console.log('const PROB_TABLES = {');
for (const [name, table] of [['low', LOW], ['medium', MEDIUM], ['high', HIGH], ['extreme', EXTREME]]) {
    console.log(`    ${name}: {`);
    for (const [pins, probs] of Object.entries(table)) {
        console.log(`        ${pins}: [${probs.join(', ')}],`);
    }
    console.log('    },');
}
console.log('};');
