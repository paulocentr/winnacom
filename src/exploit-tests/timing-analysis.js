import { verify } from '../verifier.js';

console.log('--- timing analysis ---\n');

const serverSeed = 'timing_test';
const clientSeed = 'timing_client';

// check if timing varies by outcome
const timings = { edge: [], mid: [] };

for (let n = 0; n < 2000; n++) {
    const start = process.hrtime.bigint();
    const r = verify(serverSeed, clientSeed, n, 16);
    const us = Number(process.hrtime.bigint() - start) / 1000;

    if (r.slot <= 3 || r.slot >= 13) timings.edge.push(us);
    else timings.mid.push(us);
}

const avg = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

console.log(`edge slots: ${avg(timings.edge).toFixed(1)}us avg (n=${timings.edge.length})`);
console.log(`mid slots: ${avg(timings.mid).toFixed(1)}us avg (n=${timings.mid.length})`);

const diff = Math.abs(avg(timings.edge) - avg(timings.mid));
console.log(`\ndiff: ${diff.toFixed(1)}us`);
console.log(diff < 10 ? '-> no timing leak' : '-> possible leak?');

console.log('\n\nfor api timing, use browser console:');
console.log(`
const t = { wins: [], losses: [] };
// after each bet, push response time to wins or losses
// then:
const avg = a => a.reduce((x,y)=>x+y,0)/a.length;
console.log('win avg:', avg(t.wins), 'loss avg:', avg(t.losses));
`);
