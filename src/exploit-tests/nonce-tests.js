import { verify } from '../verifier.js';

console.log('--- nonce tests ---\n');

const serverSeed = 'test_server_abc123';
const clientSeed = 'test_client';

// same inputs should give same output
const slots = [];
for (let i = 0; i < 10; i++) slots.push(verify(serverSeed, clientSeed, 42, 16).bucket);
console.log('determinism (10x same input):', slots.join(', '));
console.log(slots.every(s => s === slots[0]) ? '-> ok\n' : '-> BROKEN\n');

// different nonces should vary
const seq = [];
for (let n = 0; n < 20; n++) seq.push(verify(serverSeed, clientSeed, n, 16).bucket);
console.log('nonces 0-19:', seq.join(', '));
console.log(`unique: ${new Set(seq).size}/20\n`);

// edge cases
console.log('edge cases:');
const cases = [
    [0, 'zero'],
    [-1, 'neg'],
    [0.5, 'float'],
    [2147483647, 'int32 max'],
    [4294967295, 'uint32 max'],
    [9007199254740991, 'safe int max'],
];
for (const [val, name] of cases) {
    try {
        console.log(`  ${name}: bucket ${verify(serverSeed, clientSeed, val, 16).bucket}`);
    } catch (e) {
        console.log(`  ${name}: error`);
    }
}

// overflow
console.log('\noverflow check:');
const n0 = verify(serverSeed, clientSeed, 0, 16);
const nBig = verify(serverSeed, clientSeed, 4294967296, 16);
console.log(`  nonce 0: float ${n0.float.toFixed(10)}, bucket ${n0.bucket}`);
console.log(`  nonce 2^32: float ${nBig.float.toFixed(10)}, bucket ${nBig.bucket}`);
console.log(n0.float === nBig.float ? '  -> COLLISION (bad)' : '  -> no collision');

console.log('\nnote: test these against winna api too');
