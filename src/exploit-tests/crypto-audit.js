import crypto from 'crypto';
import { generateHash, verify, PAYOUTS } from '../verifier.js';

console.log('--- crypto audit ---\n');

const serverSeed = 'test_server_seed_12345';
const clientSeed = 'test_client';

// hmac vs plain sha256 check
console.log('hmac vs sha256:');
const msg = `${clientSeed}:0`;
const hmac = crypto.createHmac('sha256', serverSeed).update(msg).digest('hex');
const plain = crypto.createHash('sha256').update(serverSeed + msg).digest('hex');
const ours = generateHash(serverSeed, clientSeed, 0);

console.log('  hmac:', hmac.slice(0, 24) + '...');
console.log('  plain:', plain.slice(0, 24) + '...');
console.log('  ours:', ours.slice(0, 24) + '...');
if (ours === hmac) console.log('  -> using HMAC (good)\n');
else if (ours === plain) console.log('  -> using plain sha256 (BAD!)\n');
else console.log('  -> different algo?\n');

// L/R balance
console.log('L/R balance test:');
let left = 0, right = 0;
for (let n = 0; n < 50000; n++) {
    verify(serverSeed, clientSeed, n, 16).path.forEach(d => d === 'L' ? left++ : right++);
}
const lPct = (left / (left + right) * 100).toFixed(2);
console.log(`  left: ${lPct}%, right: ${(100 - lPct).toFixed(2)}%`);
console.log(Math.abs(50 - lPct) < 0.5 ? '  -> balanced\n' : '  -> biased?\n');

// slot distribution
console.log('distribution check:');
const counts = new Array(17).fill(0);
for (let n = 0; n < 50000; n++) {
    counts[verify(serverSeed, clientSeed, n, 16).slot]++;
}

let chiSq = 0;
for (let k = 0; k <= 16; k++) {
    let c = 1;
    for (let i = 0; i < k; i++) c = c * (16 - i) / (i + 1);
    const exp = Math.round(c * Math.pow(0.5, 16) * 50000);
    chiSq += exp > 0 ? Math.pow(counts[k] - exp, 2) / exp : 0;
}
console.log(`  chi-sq: ${chiSq.toFixed(2)} (critical ~26.3)`);
console.log(chiSq < 26.3 ? '  -> fair\n' : '  -> check\n');

// theoretical RTP
console.log('theoretical RTP:');
for (const [rows, risks] of Object.entries(PAYOUTS)) {
    for (const [risk, mult] of Object.entries(risks)) {
        let rtp = 0;
        const n = parseInt(rows);
        for (let k = 0; k <= n; k++) {
            let c = 1;
            for (let i = 0; i < k; i++) c = c * (n - i) / (i + 1);
            rtp += c * Math.pow(0.5, n) * mult[k];
        }
        console.log(`  ${rows}r ${risk}: ${(rtp * 100).toFixed(2)}%`);
    }
}
